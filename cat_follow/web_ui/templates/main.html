<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cat Follow - Control</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #1a1a2e; color: #e0e0e0;
      min-height: 100vh; display: flex; flex-direction: column;
    }
    header {
      background: #16213e; padding: 12px 20px;
      display: flex; align-items: center; justify-content: space-between;
      border-bottom: 2px solid #0f3460;
    }
    header h1 { font-size: 1.3rem; color: #e94560; }
    header nav a {
      color: #a0a0c0; text-decoration: none; margin-left: 20px; font-size: 0.9rem;
    }
    header nav a:hover, header nav a.active { color: #e94560; }

    main { flex: 1; padding: 20px; max-width: 900px; margin: 0 auto; width: 100%; }

    .stream-container {
      background: #0f0f23; border: 2px solid #0f3460; border-radius: 8px;
      overflow: hidden; margin-bottom: 16px; text-align: center;
    }
    .stream-container img {
      width: 100%; max-width: 640px; height: auto; display: block; margin: 0 auto;
    }

    .controls {
      display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; align-items: flex-end;
    }
    .control-group { display: flex; flex-direction: column; gap: 4px; }
    .control-group label { font-size: 0.75rem; color: #8888aa; text-transform: uppercase; }
    .control-group input {
      background: #16213e; border: 1px solid #0f3460; color: #e0e0e0;
      padding: 8px 12px; border-radius: 4px; width: 100px; font-size: 0.95rem;
    }
    .control-group select {
      background: #16213e; border: 1px solid #0f3460; color: #e0e0e0;
      padding: 8px 12px; border-radius: 4px; font-size: 0.95rem;
    }

    button {
      padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;
      font-size: 0.95rem; font-weight: 600; transition: background 0.2s;
    }
    .btn-send { background: #0f3460; color: #e0e0e0; }
    .btn-send:hover { background: #1a5276; }
    .btn-stop { background: #e94560; color: #fff; }
    .btn-stop:hover { background: #c0392b; }

    .status-bar {
      background: #16213e; border: 1px solid #0f3460; border-radius: 8px;
      padding: 12px 16px; display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 8px;
    }
    .status-item { font-size: 0.8rem; }
    .status-item .label { color: #8888aa; text-transform: uppercase; font-size: 0.65rem; }
    .status-item .value { font-size: 1rem; font-weight: 600; }
    .status-item .value.state-idle { color: #8888aa; }
    .status-item .value.state-active { color: #2ecc71; }

    .feedback {
      margin-top: 8px; padding: 8px 12px; border-radius: 4px;
      font-size: 0.85rem; display: none;
    }
    .feedback.show { display: block; }
    .feedback.ok { background: #1e4620; color: #6bdb6b; }
    .feedback.err { background: #4a1c1c; color: #e07070; }

    footer {
      text-align: center; padding: 10px; font-size: 0.7rem; color: #555;
    }
  </style>
</head>
<body>

<header>
  <h1>Cat Follow</h1>
  <nav>
    <a href="/" class="active">Control</a>
    <a href="/calibration">Calibration</a>
  </nav>
</header>

<main x-data="catFollow()" x-init="startPolling()">

  <!-- Stream -->
  <div class="stream-container">
    <img :src="streamUrl" alt="Live stream" />
  </div>

  <!-- Controls -->
  <div class="controls">
    <div class="control-group">
      <label>X (meters)</label>
      <input type="number" step="0.1" x-model="targetX" placeholder="0.0" />
    </div>
    <div class="control-group">
      <label>Y (meters)</label>
      <input type="number" step="0.1" x-model="targetY" placeholder="0.0" />
    </div>
    <button class="btn-send" @click="sendTarget()">Send Target</button>
    <button class="btn-stop" @click="sendStop()">STOP</button>

    <div class="control-group" style="margin-left: auto;">
      <label>Stream resolution</label>
      <select x-model="resolution" @change="changeResolution()">
        <option value="640x480">640x480</option>
        <option value="320x240">320x240</option>
        <option value="160x120">160x120</option>
      </select>
    </div>
  </div>

  <!-- Feedback -->
  <div class="feedback" :class="{ show: feedback, ok: feedbackOk, err: !feedbackOk }"
       x-text="feedback" x-show="feedback"
       x-transition.duration.300ms></div>

  <!-- Status bar -->
  <div class="status-bar">
    <div class="status-item">
      <div class="label">State</div>
      <div class="value" :class="status.state === 'idle' ? 'state-idle' : 'state-active'"
           x-text="status.state"></div>
    </div>
    <div class="status-item">
      <div class="label">Position</div>
      <div class="value" x-text="'(' + status.odometry.x.toFixed(2) + ', ' + status.odometry.y.toFixed(2) + ')'"></div>
    </div>
    <div class="status-item">
      <div class="label">Heading</div>
      <div class="value" x-text="status.odometry.heading_deg.toFixed(1) + '\u00B0'"></div>
    </div>
    <div class="status-item">
      <div class="label">Tracker FPS</div>
      <div class="value" x-text="status.tracker_fps"></div>
    </div>
    <div class="status-item">
      <div class="label">Stream FPS</div>
      <div class="value" x-text="status.stream_fps"></div>
    </div>
    <div class="status-item">
      <div class="label">CPU</div>
      <div class="value" x-text="status.cpu_percent >= 0 ? status.cpu_percent + '%' : 'n/a'"></div>
    </div>
    <div class="status-item">
      <div class="label">RAM</div>
      <div class="value" x-text="status.ram_percent >= 0 ? status.ram_percent + '%' : 'n/a'"></div>
    </div>
    <div class="status-item">
      <div class="label">Temp</div>
      <div class="value" x-text="status.cpu_temp >= 0 ? status.cpu_temp + '\u00B0C' : 'n/a'"></div>
    </div>
    <div class="status-item">
      <div class="label">Version</div>
      <div class="value" x-text="status.app_version"></div>
    </div>
  </div>

</main>

<footer>Cat Follow v{{ version }}</footer>

<script>
function catFollow() {
  return {
    targetX: 1.0,
    targetY: 0.0,
    resolution: '640x480',
    streamUrl: '/stream',
    feedback: '',
    feedbackOk: true,

    status: {
      state: 'idle',
      odometry: { x: 0, y: 0, heading_deg: 0 },
      bbox_tracker: { x: 0, y: 0, w: 0, h: 0, valid: 0 },
      tracker_fps: 0,
      stream_fps: 0,
      app_version: '{{ version }}',
      cpu_percent: -1,
      ram_percent: -1,
      cpu_temp: -1,
    },

    _pollTimer: null,

    startPolling() {
      this.fetchStatus();
      this._pollTimer = setInterval(() => this.fetchStatus(), 1000);
    },

    async fetchStatus() {
      try {
        const res = await fetch('/api/status');
        if (res.ok) {
          const data = await res.json();
          this.status = { ...this.status, ...data };
        }
      } catch (e) { /* ignore fetch errors */ }
    },

    async sendTarget() {
      try {
        const res = await fetch('/api/target', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ x: parseFloat(this.targetX), y: parseFloat(this.targetY) }),
        });
        const data = await res.json();
        if (res.ok) {
          this.showFeedback('Target sent: (' + data.x + ', ' + data.y + ')', true);
        } else {
          this.showFeedback(data.error || 'Error', false);
        }
      } catch (e) {
        this.showFeedback('Network error', false);
      }
    },

    async sendStop() {
      try {
        const res = await fetch('/api/stop', { method: 'POST' });
        if (res.ok) {
          this.showFeedback('Stop command sent', true);
        } else {
          this.showFeedback('Error sending stop', false);
        }
      } catch (e) {
        this.showFeedback('Network error', false);
      }
    },

    async changeResolution() {
      try {
        const res = await fetch('/api/stream/resolution', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ resolution: this.resolution }),
        });
        if (res.ok) {
          // Reload the stream by toggling the src
          this.streamUrl = '';
          setTimeout(() => { this.streamUrl = '/stream'; }, 100);
          this.showFeedback('Resolution: ' + this.resolution, true);
        }
      } catch (e) {
        this.showFeedback('Error changing resolution', false);
      }
    },

    showFeedback(msg, ok) {
      this.feedback = msg;
      this.feedbackOk = ok;
      setTimeout(() => { this.feedback = ''; }, 3000);
    },
  };
}
</script>

</body>
</html>
